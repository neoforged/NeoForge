--- a/net/minecraft/world/level/block/RailState.java
+++ b/net/minecraft/world/level/block/RailState.java
@@ -16,14 +_,16 @@
     private BlockState state;
     private final boolean isStraight;
     private final List<BlockPos> connections = Lists.newArrayList();
+    private final boolean canMakeSlopes;
 
     public RailState(Level level, BlockPos pos, BlockState state) {
         this.level = level;
         this.pos = pos;
         this.state = state;
         this.block = (BaseRailBlock)state.getBlock();
-        RailShape railshape = state.getValue(this.block.getShapeProperty());
-        this.isStraight = this.block.isStraight();
+        RailShape railshape = this.block.getRailDirection(state, level, pos, null);
+        this.isStraight = !this.block.isFlexibleRail(state, level, pos);
+        this.canMakeSlopes = this.block.canMakeSlopes(state, level, pos);
         this.updateConnections(railshape);
     }
 
@@ -179,7 +_,7 @@
             }
         }
 
-        if (railshape == RailShape.NORTH_SOUTH) {
+        if (railshape == RailShape.NORTH_SOUTH && canMakeSlopes) {
             if (BaseRailBlock.isRail(this.level, blockpos.above())) {
                 railshape = RailShape.ASCENDING_NORTH;
             }
@@ -189,7 +_,7 @@
             }
         }
 
-        if (railshape == RailShape.EAST_WEST) {
+        if (railshape == RailShape.EAST_WEST && canMakeSlopes) {
             if (BaseRailBlock.isRail(this.level, blockpos3.above())) {
                 railshape = RailShape.ASCENDING_EAST;
             }
@@ -203,6 +_,10 @@
             railshape = RailShape.NORTH_SOUTH;
         }
 
+        if (!this.block.isValidRailShape(railshape)) { // Forge: allow rail block to decide if the new shape is valid
+            this.connections.remove(state.pos);
+            return;
+        }
         this.state = this.state.setValue(this.block.getShapeProperty(), railshape);
         this.level.setBlock(this.pos, this.state, 3);
     }
@@ -305,7 +_,7 @@
             }
         }
 
-        if (railshape == RailShape.NORTH_SOUTH) {
+        if (railshape == RailShape.NORTH_SOUTH && canMakeSlopes) {
             if (BaseRailBlock.isRail(this.level, blockpos.above())) {
                 railshape = RailShape.ASCENDING_NORTH;
             }
@@ -315,7 +_,7 @@
             }
         }
 
-        if (railshape == RailShape.EAST_WEST) {
+        if (railshape == RailShape.EAST_WEST && canMakeSlopes) {
             if (BaseRailBlock.isRail(this.level, blockpos3.above())) {
                 railshape = RailShape.ASCENDING_EAST;
             }
@@ -325,7 +_,7 @@
             }
         }
 
-        if (railshape == null) {
+        if (railshape == null || !this.block.isValidRailShape(railshape)) { // Forge: allow rail block to decide if the new shape is valid
             railshape = shape;
         }
 
