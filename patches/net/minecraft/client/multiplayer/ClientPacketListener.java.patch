--- a/net/minecraft/client/multiplayer/ClientPacketListener.java
+++ b/net/minecraft/client/multiplayer/ClientPacketListener.java
@@ -340,6 +_,7 @@
     private MessageSignatureCache messageSignatureCache = MessageSignatureCache.createDefault();
     private final ChunkBatchSizeCalculator chunkBatchSizeCalculator = new ChunkBatchSizeCalculator();
     private final PingDebugMonitor pingDebugMonitor;
+    private final boolean isModdedConnection;
     @Nullable
     private LevelLoadStatusManager levelLoadStatusManager;
     private boolean seenInsecureChatWarning = false;
@@ -353,6 +_,7 @@
         this.advancements = new ClientAdvancements(p_253924_, this.telemetryManager);
         this.suggestionsProvider = new ClientSuggestionProvider(this, p_253924_);
         this.pingDebugMonitor = new PingDebugMonitor(this, p_253924_.getDebugOverlay().getPingLogger());
+        this.isModdedConnection = p_295121_.isModdedConnection();
     }
 
     public ClientSuggestionProvider getSuggestionsProvider() {
@@ -416,6 +_,7 @@
 
         this.minecraft.debugRenderer.clear();
         this.minecraft.player.resetPos();
+        net.neoforged.neoforge.client.ClientHooks.firePlayerLogin(this.minecraft.gameMode, this.minecraft.player, this.minecraft.getConnection().connection);
         this.minecraft.player.setId(p_105030_.playerId());
         this.level.addEntity(this.minecraft.player);
         this.minecraft.player.input = new KeyboardInput(this.minecraft.options);
@@ -799,6 +_,7 @@
                         this.telemetryManager,
                         this.registryAccess,
                         this.enabledFeatures,
+                        this.isModdedConnection,
                         this.serverBrand,
                         this.serverData,
                         this.postDisconnectScreen
@@ -1143,6 +_,7 @@
         }
 
         localplayer1.resetPos();
+        net.neoforged.neoforge.client.ClientHooks.firePlayerRespawn(this.minecraft.gameMode, localplayer, localplayer1, localplayer1.connection.connection);
         this.level.addEntity(localplayer1);
         localplayer1.setYRot(-180.0F);
         localplayer1.input = new KeyboardInput(this.minecraft.options);
@@ -1274,10 +_,7 @@
         PacketUtils.ensureRunningOnSameThread(p_104976_, this, this.minecraft);
         BlockPos blockpos = p_104976_.getPos();
         this.minecraft.level.getBlockEntity(blockpos, p_104976_.getType()).ifPresent(p_205557_ -> {
-            CompoundTag compoundtag = p_104976_.getTag();
-            if (compoundtag != null) {
-                p_205557_.load(compoundtag);
-            }
+            p_205557_.onDataPacket(connection, p_104976_);
 
             if (p_205557_ instanceof CommandBlockEntity && this.minecraft.screen instanceof CommandBlockEditScreen) {
                 ((CommandBlockEditScreen)this.minecraft.screen).updateGui();
@@ -1446,7 +_,9 @@
     @Override
     public void handleCommands(ClientboundCommandsPacket p_104990_) {
         PacketUtils.ensureRunningOnSameThread(p_104990_, this, this.minecraft);
-        this.commands = new CommandDispatcher<>(p_104990_.getRoot(CommandBuildContext.simple(this.registryAccess, this.enabledFeatures)));
+        var context = CommandBuildContext.simple(this.registryAccess, this.enabledFeatures);
+        this.commands = new CommandDispatcher<>(p_104990_.getRoot(context));
+        this.commands = net.neoforged.neoforge.client.ClientCommandHandler.mergeServerCommands(this.commands, context);
     }
 
     @Override
@@ -1468,6 +_,7 @@
         ClientRecipeBook clientrecipebook = this.minecraft.player.getRecipeBook();
         clientrecipebook.setupCollections(this.recipeManager.getRecipes(), this.minecraft.level.registryAccess());
         this.minecraft.populateSearchTree(SearchRegistry.RECIPE_COLLECTIONS, clientrecipebook.getCollections());
+        net.neoforged.neoforge.client.ClientHooks.onRecipesUpdated(this.recipeManager);
     }
 
     @Override
@@ -1574,7 +_,8 @@
             Blocks.rebuildCache();
         }
 
-        CreativeModeTabs.searchTab().rebuildSearchTree();
+        CreativeModeTabs.allTabs().stream().filter(net.minecraft.world.item.CreativeModeTab::hasSearchBar).forEach(net.minecraft.world.item.CreativeModeTab::rebuildSearchTree);
+        net.neoforged.neoforge.common.NeoForge.EVENT_BUS.post(new net.neoforged.neoforge.event.TagsUpdatedEvent(this.registryAccess, true, connection.isMemoryConnection()));
     }
 
     @Override
@@ -1916,21 +_,25 @@
     }
 
     @Override
-    public void handleCustomPayload(CustomPacketPayload p_295851_) {
+    public void handleCustomPayload(net.minecraft.network.protocol.common.ClientboundCustomPayloadPacket p_295727_, CustomPacketPayload p_295851_) {
         if (p_295851_ instanceof PathfindingDebugPayload pathfindingdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft
                 .debugRenderer
                 .pathfindingRenderer
                 .addPath(pathfindingdebugpayload.entityId(), pathfindingdebugpayload.path(), pathfindingdebugpayload.maxNodeDistance());
         } else if (p_295851_ instanceof NeighborUpdatesDebugPayload neighborupdatesdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             ((NeighborsUpdateRenderer)this.minecraft.debugRenderer.neighborsUpdateRenderer)
                 .addUpdate(neighborupdatesdebugpayload.time(), neighborupdatesdebugpayload.pos());
         } else if (p_295851_ instanceof StructuresDebugPayload structuresdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft
                 .debugRenderer
                 .structureRenderer
                 .addBoundingBox(structuresdebugpayload.mainBB(), structuresdebugpayload.pieces(), structuresdebugpayload.dimension());
         } else if (p_295851_ instanceof WorldGenAttemptDebugPayload worldgenattemptdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             ((WorldGenAttemptRenderer)this.minecraft.debugRenderer.worldGenAttemptRenderer)
                 .addPos(
                     worldgenattemptdebugpayload.pos(),
@@ -1941,27 +_,36 @@
                     worldgenattemptdebugpayload.alpha()
                 );
         } else if (p_295851_ instanceof PoiTicketCountDebugPayload poiticketcountdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.brainDebugRenderer.setFreeTicketCount(poiticketcountdebugpayload.pos(), poiticketcountdebugpayload.freeTicketCount());
         } else if (p_295851_ instanceof PoiAddedDebugPayload poiaddeddebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             BrainDebugRenderer.PoiInfo braindebugrenderer$poiinfo = new BrainDebugRenderer.PoiInfo(
                 poiaddeddebugpayload.pos(), poiaddeddebugpayload.type(), poiaddeddebugpayload.freeTicketCount()
             );
             this.minecraft.debugRenderer.brainDebugRenderer.addPoi(braindebugrenderer$poiinfo);
         } else if (p_295851_ instanceof PoiRemovedDebugPayload poiremoveddebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.brainDebugRenderer.removePoi(poiremoveddebugpayload.pos());
         } else if (p_295851_ instanceof VillageSectionsDebugPayload villagesectionsdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             VillageSectionsDebugRenderer villagesectionsdebugrenderer = this.minecraft.debugRenderer.villageSectionsDebugRenderer;
             villagesectionsdebugpayload.villageChunks().forEach(villagesectionsdebugrenderer::setVillageSection);
             villagesectionsdebugpayload.notVillageChunks().forEach(villagesectionsdebugrenderer::setNotVillageSection);
         } else if (p_295851_ instanceof GoalDebugPayload goaldebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.goalSelectorRenderer.addGoalSelector(goaldebugpayload.entityId(), goaldebugpayload.pos(), goaldebugpayload.goals());
         } else if (p_295851_ instanceof BrainDebugPayload braindebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.brainDebugRenderer.addOrUpdateBrainDump(braindebugpayload.brainDump());
         } else if (p_295851_ instanceof BeeDebugPayload beedebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.beeDebugRenderer.addOrUpdateBeeInfo(beedebugpayload.beeInfo());
         } else if (p_295851_ instanceof HiveDebugPayload hivedebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.beeDebugRenderer.addOrUpdateHiveInfo(hivedebugpayload.hiveInfo(), this.level.getGameTime());
         } else if (p_295851_ instanceof GameTestAddMarkerDebugPayload gametestaddmarkerdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft
                 .debugRenderer
                 .gameTestDebugRenderer
@@ -1972,24 +_,36 @@
                     gametestaddmarkerdebugpayload.durationMs()
                 );
         } else if (p_295851_ instanceof GameTestClearMarkersDebugPayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.gameTestDebugRenderer.clear();
         } else if (p_295851_ instanceof RaidsDebugPayload raidsdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.raidDebugRenderer.setRaidCenters(raidsdebugpayload.raidCenters());
         } else if (p_295851_ instanceof GameEventDebugPayload gameeventdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.gameEventListenerRenderer.trackGameEvent(gameeventdebugpayload.type(), gameeventdebugpayload.pos());
         } else if (p_295851_ instanceof GameEventListenerDebugPayload gameeventlistenerdebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft
                 .debugRenderer
                 .gameEventListenerRenderer
                 .trackListener(gameeventlistenerdebugpayload.listenerPos(), gameeventlistenerdebugpayload.listenerRange());
         } else if (p_295851_ instanceof BreezeDebugPayload breezedebugpayload) {
+            PacketUtils.ensureRunningOnSameThread(p_295727_, this, this.minecraft); //Neo: We move this here to ensure that only vanilla packets are handled on the main thread.
             this.minecraft.debugRenderer.breezeDebugRenderer.add(breezedebugpayload.breezeInfo());
         } else {
-            this.handleUnknownCustomPayload(p_295851_);
+            if (this.isModdedConnection) {
+                net.neoforged.neoforge.network.registration.NetworkRegistry.getInstance().onModdedPacketAtClient(
+                        this, p_295727_
+                );
+                return;
+            }
+            
+            this.handleUnknownCustomPayload(p_295727_, p_295851_);
         }
     }
 
-    private void handleUnknownCustomPayload(CustomPacketPayload p_294389_) {
+    private void handleUnknownCustomPayload(net.minecraft.network.protocol.common.ClientboundCustomPayloadPacket p_295727_, CustomPacketPayload p_294389_) {
         LOGGER.warn("Unknown custom packet payload: {}", p_294389_.id());
     }
 
@@ -2267,7 +_,7 @@
     public void handleBundlePacket(ClientboundBundlePacket p_265195_) {
         PacketUtils.ensureRunningOnSameThread(p_265195_, this, this.minecraft);
 
-        for(Packet<ClientGamePacketListener> packet : p_265195_.subPackets()) {
+        for(Packet<? super ClientGamePacketListener> packet : p_265195_.subPackets()) {
             packet.handle(this);
         }
     }
@@ -2389,6 +_,8 @@
     }
 
     public void sendChat(String p_249888_) {
+        p_249888_ = net.neoforged.neoforge.client.ClientHooks.onClientSendMessage(p_249888_);
+        if (p_249888_.isEmpty()) return;
         Instant instant = Instant.now();
         long i = Crypt.SaltSupplier.getLong();
         LastSeenMessagesTracker.Update lastseenmessagestracker$update = this.lastSeenMessages.generateAndApplyUpdate();
@@ -2398,6 +_,7 @@
     }
 
     public void sendCommand(String p_250092_) {
+        if (net.neoforged.neoforge.client.ClientCommandHandler.runCommand(p_250092_)) return;
         Instant instant = Instant.now();
         long i = Crypt.SaltSupplier.getLong();
         LastSeenMessagesTracker.Update lastseenmessagestracker$update = this.lastSeenMessages.generateAndApplyUpdate();
